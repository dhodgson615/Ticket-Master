{% extends "base.html" %}

{% block title %}Results - Ticket-Master{% endblock %}

{% block content %}
<div class="results-header">
    <div class="results-summary">
        <h2>
            {% if dry_run %}
                üîç Dry Run Results
            {% else %}
                ‚úÖ Issue Generation Complete
            {% endif %}
        </h2>
        <div class="summary-stats">
            <div class="stat">
                <span class="stat-number">{{ results|length }}</span>
                <span class="stat-label">
                    {% if dry_run %}Issues Analyzed{% else %}Issues Processed{% endif %}
                </span>
            </div>
            <div class="stat">
                <span class="stat-number">{{ results|selectattr('created')|list|length or results|selectattr('would_create')|list|length }}</span>
                <span class="stat-label">
                    {% if dry_run %}Would Create{% else %}Successfully Created{% endif %}
                </span>
            </div>
            {% if not dry_run %}
            <div class="stat">
                <span class="stat-number">{{ results|selectattr('error')|list|length }}</span>
                <span class="stat-label">Failed</span>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="repository-info">
        <h3>Repository Information</h3>
        <div class="repo-details">
            <div class="repo-detail">
                <strong>Local Path:</strong> <code>{{ repository_path }}</code>
            </div>
            <div class="repo-detail">
                <strong>GitHub Repo:</strong> <code>{{ github_repo }}</code>
            </div>
            {% if analysis %}
            <div class="repo-detail">
                <strong>Commits Analyzed:</strong> {{ analysis.commit_count or 'N/A' }}
            </div>
            <div class="repo-detail">
                <strong>Files Modified:</strong> {{ analysis.files_modified or 'N/A' }}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="issues-section">
    <h3>Generated Issues</h3>
    
    {% if results %}
        <div class="issues-list">
            {% for result in results %}
            <div class="issue-card {% if result.error %}issue-error{% elif result.created or result.would_create %}issue-success{% endif %}">
                <div class="issue-header">
                    <div class="issue-status">
                        {% if result.error %}
                            <span class="status-icon error">‚ùå</span>
                            <span class="status-text">Error</span>
                        {% elif result.created %}
                            <span class="status-icon success">‚úÖ</span>
                            <span class="status-text">Created</span>
                        {% elif result.would_create %}
                            <span class="status-icon preview">üîç</span>
                            <span class="status-text">Would Create</span>
                        {% endif %}
                    </div>
                    
                    {% if result.url %}
                    <a href="{{ result.url }}" target="_blank" rel="noopener" class="issue-link">
                        <span class="link-icon">üîó</span>
                        View on GitHub
                    </a>
                    {% endif %}
                </div>
                
                <div class="issue-content">
                    <h4 class="issue-title">{{ result.title }}</h4>
                    
                    {% if result.labels %}
                    <div class="issue-labels">
                        {% for label in result.labels %}
                        <span class="label">{{ label }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="issue-description">
                        <div class="description-preview">
                            {{ result.description[:200] }}{% if result.description|length > 200 %}...{% endif %}
                        </div>
                        
                        {% if result.description|length > 200 %}
                        <details class="full-description">
                            <summary>Show full description</summary>
                            <div class="description-full">
                                <pre>{{ result.description }}</pre>
                            </div>
                        </details>
                        {% endif %}
                    </div>
                    
                    {% if result.error %}
                    <div class="error-details">
                        <strong>Error:</strong> {{ result.error }}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="no-results">
            <div class="no-results-icon">üìù</div>
            <h4>No Issues Generated</h4>
            <p>No issues were generated for this repository. This could be due to the repository being very new, having minimal activity, or configuration settings.</p>
        </div>
    {% endif %}
</div>

<div class="actions-section">
    <div class="action-buttons">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <span class="btn-icon">üîÑ</span>
            Generate More Issues
        </a>
        
        {% if not dry_run and results|selectattr('created')|list|length > 0 %}
        <a href="https://github.com/{{ github_repo }}/issues" target="_blank" rel="noopener" class="btn btn-primary">
            <span class="btn-icon">üîó</span>
            View on GitHub
        </a>
        {% endif %}
        
        {% if dry_run %}
        <form method="POST" action="{{ url_for('generate_issues') }}" style="display: inline;">
            <input type="hidden" name="repository_path" value="{{ repository_path }}">
            <input type="hidden" name="github_repo" value="{{ github_repo }}">
            <input type="hidden" name="max_issues" value="{{ results|length }}">
            <button type="submit" class="btn btn-primary">
                <span class="btn-icon">üöÄ</span>
                Create These Issues
            </button>
        </form>
        {% endif %}
    </div>
</div>

{% if analysis %}
<div class="analysis-section">
    <details class="analysis-details">
        <summary>
            <h3>Repository Analysis Details</h3>
        </summary>
        <div class="analysis-content">
            <pre><code>{{ analysis | tojson(indent=2) }}</code></pre>
        </div>
    </details>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Add some interactivity to the results page
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-scroll to issues section
        const issuesSection = document.querySelector('.issues-section');
        if (issuesSection) {
            setTimeout(() => {
                issuesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 500);
        }
        
        // Add copy functionality for code blocks
        const codeBlocks = document.querySelectorAll('pre code');
        codeBlocks.forEach(block => {
            block.addEventListener('click', function() {
                navigator.clipboard.writeText(this.textContent).then(() => {
                    // Show temporary feedback
                    const originalBg = this.style.backgroundColor;
                    this.style.backgroundColor = 'var(--success-color)';
                    setTimeout(() => {
                        this.style.backgroundColor = originalBg;
                    }, 200);
                });
            });
        });
    });
</script>
{% endblock %}